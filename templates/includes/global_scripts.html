<script>
    // --- L√ìGICA 1: FAVORITOS (Wishlist) ---
    document.addEventListener('DOMContentLoaded', function() {
        const btn = document.getElementById('wishlist-btn');
        if (!btn) return;

        const productId = btn.dataset.id;
        const icon = document.getElementById('heart-icon');

        // Verifica LocalStorage
        let favorites = JSON.parse(localStorage.getItem('emporio_favorites') || '[]');

        if (favorites.includes(productId)) {
            icon.classList.replace('bi-heart', 'bi-heart-fill');
            icon.classList.add('text-danger');
        }

        // Click para Adicionar/Remover
        btn.addEventListener('click', function() {
            favorites = JSON.parse(localStorage.getItem('emporio_favorites') || '[]');

            if (favorites.includes(productId)) {
                favorites = favorites.filter(id => id !== productId);
                icon.classList.replace('bi-heart-fill', 'bi-heart');
                icon.classList.remove('text-danger');
            } else {
                favorites.push(productId);
                icon.classList.replace('bi-heart', 'bi-heart-fill');
                icon.classList.add('text-danger');

                // Anima√ß√£o
                icon.animate([
                    { transform: 'scale(1)' }, { transform: 'scale(1.4)' }, { transform: 'scale(1)' }
                ], { duration: 400 });
            }
            localStorage.setItem('emporio_favorites', JSON.stringify(favorites));
        });
    });

    // --- L√ìGICA 2: CARRINHO (Add to Cart) ---
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.btn-add-cart') || e.target.closest('.add-to-cart');

        if (btn) {
            e.preventDefault();
            if (btn.disabled) return;

            const url = btn.getAttribute('href') || btn.dataset.url;
            const originalContent = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                // Atualiza Badges
                const badges = document.querySelectorAll('#cart-badge, .navbar-glass .badge');
                badges.forEach(badge => {
                    badge.innerText = data.total_items;
                    badge.classList.remove('d-none');
                    badge.animate([
                        { transform: 'scale(1)' }, { transform: 'scale(1.3)' }, { transform: 'scale(1)' }
                    ], { duration: 300 });
                });

                // Feedback Bot√£o
                btn.classList.replace('btn-burgundy', 'btn-success');
                btn.innerHTML = '‚úÖ Adicionado';

                // Toast
                showCartToast(data.product_name || 'Produto');

                setTimeout(() => {
                    btn.classList.replace('btn-success', 'btn-burgundy');
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }, 2000);
            })
            .catch(error => {
                console.error('Erro:', error);
                btn.innerHTML = '‚ùå Erro';
                btn.disabled = false;
            });
        }
    });

    // --- L√ìGICA 3: TOAST DE NOTIFICA√á√ÉO ---
    function showCartToast(productName) {
        const toastContainer = document.createElement('div');
        toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '2000';
        toastContainer.innerHTML = `
            <div class="toast show align-items-center text-white bg-success border-0 shadow-lg" role="alert">
                <div class="d-flex">
                    <div class="toast-body fw-bold">
                        üç∑ ${productName}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        document.body.appendChild(toastContainer);
        setTimeout(() => { toastContainer.remove(); }, 3000);
    }

    // --- L√ìGICA 4: NEWSLETTER (Nova) ---
    function submitNewsletter() {
        const emailInput = document.getElementById('newsletterEmail');
        const btn = document.getElementById('btnNewsletter');
        const msg = document.getElementById('newsletterMsg');
        const email = emailInput.value;

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        msg.innerText = '';
        msg.className = 'd-block mt-2 fw-bold';

        // Ajuste a URL se necess√°rio (ex: /pages/newsletter/assinar/)
        fetch('/pages/newsletter/assinar/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 'email': email })
        })
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = 'Assinar';

            if (data.success) {
                msg.innerText = data.message;
                msg.classList.add('text-success');
                emailInput.value = '';
                showCartToast("Inscri√ß√£o confirmada! üç∑");
            } else {
                msg.innerText = data.message;
                msg.classList.add('text-danger');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            btn.disabled = false;
            btn.innerHTML = 'Assinar';
            msg.innerText = 'Erro de conex√£o.';
            msg.classList.add('text-danger');
        });
    }
</script>