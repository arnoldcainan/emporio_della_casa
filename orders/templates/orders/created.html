{% extends 'base.html' %}

{% block content %}
<div class="container py-5 text-center">
    <div class="card shadow-sm p-5 border-0 bg-white" style="max-width: 800px; margin: 0 auto;">
        <h1 class="fw-bold text-success">Pedido #{{ order.id }} Reservado!</h1>
        <p class="lead text-muted">Finalize o pagamento abaixo para garantir seus vinhos:</p>

        <div class="my-4 p-4 bg-light rounded border">
            <h5 class="fw-bold mb-4">Total com Frete: R$ {{ order.get_total_cost }}</h5>

            {% if pix_data %}
                <div class="pix-container">
                    <h5 class="fw-bold text-primary mb-3">Escaneie o QR Code abaixo:</h5>
                    <div class="bg-white p-3 d-inline-block rounded shadow-sm mb-3">
                        <img src="data:image/png;base64, {{ pix_data.encodedImage }}" alt="QR Code PIX" class="img-fluid" style="max-width: 250px;">
                    </div>

                    <p class="text-muted small mb-2">Ou utilize o código Copia e Cola:</p>
                    <div class="input-group mb-3 mx-auto" style="max-width: 400px;">
                        <input type="text" value="{{ pix_data.payload }}" id="pixCode" class="form-control form-control-sm" readonly>
                        <button class="btn btn-primary btn-sm" onclick="copyPix()">
                            <i class="bi bi-clipboard"></i> Copiar
                        </button>
                    </div>
                    <div class="alert alert-info py-2 small">
                        Aprovação imediata! O status do seu pedido será atualizado automaticamente.
                    </div>
                </div>

            {% elif payment_url %}
                <div class="payment-link-container">
                    <h5 class="fw-bold mb-3">Pagamento via Cartão de Crédito</h5>
                    <p>Para sua segurança, o pagamento é processado em um ambiente criptografado.</p>
                    <a href="{{ payment_url }}" target="_blank" class="btn btn-success btn-lg px-5 fw-bold shadow">
                        <i class="bi bi-credit-card"></i> IR PARA PAGAMENTO SEGURO
                    </a>
                    <p class="mt-3 text-muted small">Parcele em até 12x no cartão.</p>
                </div>

            {% else %}
                <div class="alert alert-warning">
                    Estamos processando seu link de pagamento. Por favor, atualize a página em alguns instantes.
                </div>
            {% endif %}
        </div>

        <a href="{% url 'products:home' %}" class="btn btn-outline-secondary mt-3">Voltar para a Loja</a>
    </div>
</div>

<script>
    function copyPix() {
        var copyText = document.getElementById("pixCode");
        copyText.select();
        copyText.setSelectionRange(0, 99999); // Para dispositivos móveis

        navigator.clipboard.writeText(copyText.value).then(() => {
            alert("Código PIX copiado com sucesso!");
        }).catch(err => {
            console.error('Erro ao copiar: ', err);
        });
    }
</script>

<style>
    .pix-container img {
        border: 1px solid #eee;
    }
    .btn-success {
        background-color: #198754;
        border-color: #198754;
    }
</style>
{% endblock %}